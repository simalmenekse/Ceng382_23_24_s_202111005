@page
@model ReservationShowModel
@{
    ViewData["Title"] = "Reservations";

    DateTime today = DateTime.Now.Date;
    int daysToMonday = ((int)DayOfWeek.Monday - (int)today.DayOfWeek - 7) % 7;
    DateTime startOfWeek = today.AddDays(daysToMonday);
}

<h2>Reservations</h2><br>
<form method="get" class="mb-4">
    <div class="form-row">
        <div class="col">
            <input type="text" id="roomFilter" name="roomFilter" value="@Model.RoomFilter" placeholder="Room" class="form-control" />
        </div>
        <div class="col">
            <input type="date" id="startDateFilter" name="startDateFilter" value="@Model.StartDateFilter?.ToString("yyyy-MM-dd")" placeholder="Start Date" class="form-control" />
        </div>
        <div class="col">
            <input type="date" id="endDateFilter" name="endDateFilter" value="@Model.EndDateFilter?.ToString("yyyy-MM-dd")" placeholder="End Date" class="form-control" />
        </div>
        <div class="col">
            <input type="number" id="capacityFilter" name="capacityFilter" value="@Model.CapacityFilter" placeholder="Capacity" class="form-control" />
        </div>
        <div class="col">
            <button type="submit" class="btn btn-primary">Filter</button>
                        <a href="/ReservationShow" class="btn btn-secondary ml-2">Remove Filter</a>

        </div>
    </div>
</form>

<div class="table-responsive">
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Time</th>
                @for (var i = 0; i < 7; i++)
                {
                    <th>@startOfWeek.AddDays(i).ToString("dddd")</th>
                }
            </tr>
        </thead>
        <tbody>
            @for (var hour = 9; hour < 18; hour++) 
            {
                <tr>
                    <td>@hour:00</td>
                    @for (var day = 0; day < 7; day++)
                    {
                        var currentDateTime = startOfWeek.AddDays(day).AddHours(hour);
                        
                        var capturedHour = hour;  

                        var reservation = Model.Reservations.FirstOrDefault(r => 
                            r.DateTime.Hour == capturedHour && r.DateTime.Date == currentDateTime.Date
                        );

                        <td>
                            @if (reservation != null)
                            {
                                <div>
                                    <b>Room Name: </b>@reservation.Room.RoomName<br />
                                    <b>Time: </b>@reservation.DateTime.ToString("HH:mm")<br />
                                    <b>Reserved By: </b>@Model.GetFriendlyName(reservation.ReservedBy)
                                    <div class="mt-2">
                                        <a href="/Reservations/Edit?id=@reservation.Id" class="btn btn-sm btn-warning float-left">✏ Edit</a>
                                        <form method="post" asp-page-handler="Delete" asp-route-id="@reservation.Id" onsubmit="return confirm('Are you sure you want to delete this reservation?');">
                                            <button type="submit" class="btn btn-sm btn-danger float-left ml-1">❌ Delete</button>
                                        </form>
                                        <div class="clearfix"></div> 
                                    </div>
                                </div>
                            }
                        </td> 
                    }
                </tr>
            }
        </tbody>
    </table>
</div>

@section Scripts {
    <script>
        $('#confirmDeleteModal').on('hidden.bs.modal', function () {
            $('.modal-backdrop').remove();
        });
    </script>
}
